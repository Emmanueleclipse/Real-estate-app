
/*! banks.js - Author: BienFacile, License: Bienfacile, more info: http://www.bienfacile.com/ */
banks=new FeedObject('/json_banks/');banks.me='banks';banks.all=function(a,b,c){c.isotope=false;output=[];c.wrapper='table';c.wrapper_class='table table-striped';c.childwrapper='tr';for(var d=0;d<b.length;d++){var e=b[d];output.push({infinitescroll:e.infinitescroll,html:"<td><a href=\"javascript:bankentries.filter('#bankentries', 'bank_account_id', "+e.id+");bankentries.display(0);bankentries.current_account = "+e.id+";bankentries.title('"+e.account_name+"');\">"+e.account_name+'</a></td><td>'+e.bank_name+'</td><td>'+e.bank_address+"</td><td><a href=\"javascript:banks.modal('#modal', { title : 'Modifier banque', hidden: { id: "+e.id+" } });\">"+(e['for']=='agence'?'Agence':'Personelle')+(e.current?' / Actif':'')+'</a></td>'});}this.list(a,output,c);};banks.form=function(){return [{type:'input',field:'bank_name',title:'Nom',required:true},{type:'input',field:'bank_address',title:'Adresse',required:true},{type:'input',field:'account_name',title:'Nom sur compte',required:true},{type:'textarea',field:'description',title:'Descriptif'},[[{type:'input',field:'iban',title:'IBAN'}],[{type:'input',field:'bic',title:'BIC'}]],[[{type:'date',field:'opened_date',title:'Ouverture'}],[{type:'date',field:'closed_date',title:'Fermature'}]],{type:'input',field:'balance',title:'Solde'},[[{type:'radio',field:'for',title:'Pour',options:{agent:'Moi',agence:'Agence'}}],[{type:'select2',field:'agent_id',title:'Agent',required:true,options:myagency.options('fullname')}]]];};bankentries=new FeedObject('/json_bankentries/');bankentries.me='bankentries';bankentries.title=function(a){$('#bankname').text(a);};bankentries.all=function(a,b,c){var d,e;c.isotope=false;output=[];c.wrapper='table';c.wrapper_class='table table-striped';c.childwrapper='tr';for(var f=0;f<b.length;f++){d=b[f];e=concat_cells({'cell_open':"<td><a href=\"javascript:bankentries.modal('#modal', { title : 'Modifier', hidden: { id: "+d.id+", 'bank_account_id' : "+d.bank_account_id+" } });\">",'cell_close':'</a></td>','cells':[d.date,'&euro;'+d.amount,d.reference,d.comment]});output.push({'search':(d.comment?d.comment.toLowerCase():'')+' '+(d.reference?d.reference.toLowerCase():''),infinitescroll:d.infinitescroll,html:e});}this.list(a,output,c);};bankentries.form=function(){return [[[{type:'input',field:'reference',title:'Reference'}],[{type:'input',field:'comment',title:'Motif'}]],[[{type:'input',field:'amount',title:'Montant',required:true}],[{type:'date',field:'date',title:'Date'}]]];};bankentries.upload=function(a,b){if(!b)var b={};if(!b.hidden)b.hidden={};b.hidden.csrfmiddlewaretoken=window.csrf;b.header='<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Fermer"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">'+(b.title?b.title:'Missing title')+'</h4></div><div class="modal-body">';b.footer='</div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>';if(!b.hidden.bank_account_id)b.bodytop="Choisir une banque";else b.bodytop='<div id="drag-drop-area"></div><div class="uppy-ProgressBar"></div>'+"<script>var uppy = Uppy.Core( { autoProceed: true, logger: Uppy.debugLogger, debug: true } );"+"uppy.use(Uppy.DragDrop, { target: '#drag-drop-area' });"+"uppy.use(Uppy.XHRUpload, { endpoint: 'https://agence.bienfacile.com/json_bankupload/' });"+"uppy.on('upload-success', (file,response) => { if (response.body['success']) $('"+a+"form_results').append(response.body['success']+'<br/>'); if (response.body['error']) $('"+a+"form_errors').append(response.body['error']+'<br/>'); bankentries.display()});"+"uppy.use(Uppy.ProgressBar, { target: '.uppy-ProgressBar', hideAfterFinish: true });"+"uppy.on('upload-error', (file, error, response) => $('"+a+"form_errors').append('File: '+file.id+' - '+error));"+"uppy.use(Uppy.Form, { target: '"+a+"form', getMetaFromForm: true });"+"</script>";var c=$(a),d={};c.find('.modal-content').html(this.renderform(a,d,b));this.forminitialise(a,true,d);c.modal('show');};